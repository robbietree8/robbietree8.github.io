<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>influxdb and grafana |</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content><meta name=twitter:title content="influxdb and grafana"><meta name=twitter:description content><meta name=Description content><meta property="og:title" content="influxdb and grafana"><meta property="og:description" content="InfluxDB & Grafana 趟坑过程记录 InfluxDB  子查询查最新版本号的分布情况
 select count(*) from (select count(value) from table where app =~ /^abc/ group by &#34;app&#34;, &#34;version&#34; order by time desc limit 1) group by &#34;app&#34;, &#34;version&#34; order by time desc 在子查询里，已经按照时间拿最新的一条数据，但是在外面再套一层之后，老的数据又出来了，这个问题暂时没解，而是通过新的数据过来之后，删掉老的数据规避掉。"><meta property="og:type" content="article"><meta property="og:url" content="https://robbietree8.github.io/posts/2019-03-15-influxdb-and-grafana/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-15T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-15T00:00:00+00:00"><meta name=application-name content="robbietree's blog"><meta name=apple-mobile-web-app-title content="robbietree's blog"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://robbietree8.github.io/posts/2019-03-15-influxdb-and-grafana/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"influxdb and grafana","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/robbietree8.github.io\/posts\/2019-03-15-influxdb-and-grafana\/"},"genre":"posts","wordCount":233,"url":"https:\/\/robbietree8.github.io\/posts\/2019-03-15-influxdb-and-grafana\/","datePublished":"2019-03-15T00:00:00+00:00","dateModified":"2019-03-15T00:00:00+00:00","description":""}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'light'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'light'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="robbietree's blog" class="header-logo logo-svg">robbietree's blog</a></div><div class=menu><nav><ul class=menu-inner><li><a class=menu-item href=/posts/>Posts</a></li><li><a class=menu-item href=/tags/>Tags</a></li><li><a class=menu-item href=/categories/>Categories</a></li></ul></nav><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><span class="svg-icon icon-moon"></span></a></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="robbietree's blog" class=header-logo>robbietree's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><nav><ul><li><a class=menu-item href=/posts/ title>Posts</a></li><li><a class=menu-item href=/tags/ title>Tags</a></li><li><a class=menu-item href=/categories/ title>Categories</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><span class="svg-icon icon-moon"></span></a></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>目录</div><div class=toc-content id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><nav class=breadcrumbs><ol><li><a href=/>主页</a></li><li>influxdb and grafana</li></ol></nav><h1 class="single-title flipInX">influxdb and grafana</h1><div class=post-meta><div class=post-meta-line><span class=post-meta-date><i class="svg-icon icon-clock"></i><time class=timeago datetime=2019-03-15>2019-03-15</time>
</span><span class=post-meta-words><i class="svg-icon icon-pencil"></i>约 233 字</span>
<span class=post-meta-reading><i class="svg-icon icon-stopwatch"></i>预计阅读 2 分钟</span></div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#influxdb>InfluxDB</a></li><li><a href=#grafana>Grafana</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></div><h1 id=influxdb--grafana-趟坑过程记录>InfluxDB & Grafana 趟坑过程记录</h1><h2 id=influxdb>InfluxDB</h2><blockquote><p>子查询查最新版本号的分布情况</p></blockquote><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span> <span class=k>count</span><span class=p>(</span><span class=o>*</span><span class=p>)</span> <span class=k>from</span> <span class=p>(</span><span class=k>select</span> <span class=k>count</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=k>from</span> <span class=k>table</span> <span class=k>where</span> <span class=n>app</span> <span class=o>=~</span> <span class=o>/^</span><span class=n>abc</span><span class=o>/</span> <span class=k>group</span> <span class=k>by</span> <span class=s2>&#34;app&#34;</span><span class=p>,</span> <span class=s2>&#34;version&#34;</span> <span class=k>order</span> <span class=k>by</span> <span class=n>time</span> <span class=k>desc</span> <span class=k>limit</span> <span class=mi>1</span><span class=p>)</span> <span class=k>group</span> <span class=k>by</span> <span class=s2>&#34;app&#34;</span><span class=p>,</span> <span class=s2>&#34;version&#34;</span> <span class=k>order</span> <span class=k>by</span> <span class=n>time</span> <span class=k>desc</span>
</code></pre></div><p>在子查询里，已经按照时间拿最新的一条数据，但是在外面再套一层之后，老的数据又出来了，这个问题暂时没解，而是通过新的数据过来之后，删掉老的数据规避掉。</p><blockquote><p>时区问题</p></blockquote><p>默认情况下，<code>InfluxDB</code>使用UTC来计算时间区块的数据，可以使用<code>tz()</code>子句来指定时区，比如如下指定了<code>UTC+8</code>时区</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=k>sum</span><span class=p>(</span><span class=s2>&#34;value&#34;</span><span class=p>)</span> <span class=k>FROM</span> <span class=s2>&#34;table&#34;</span> <span class=k>GROUP</span> <span class=k>BY</span> <span class=n>time</span><span class=p>(</span><span class=err>$</span><span class=n>__interval</span><span class=p>)</span> <span class=n>fill</span><span class=p>(</span><span class=k>null</span><span class=p>)</span> <span class=n>tz</span><span class=p>(</span><span class=s1>&#39;Asia/Shanghai&#39;</span><span class=p>)</span>
</code></pre></div><h2 id=grafana>Grafana</h2><blockquote><p>Variables - Include All option</p></blockquote><p>Grafana里可以配置变量，后续变量可以在绘制Dashboard的时候使用，如下图所示</p><p><strong>配置界面</strong></p><p><img loading=lazy decoding=async src=https://i.loli.net/2019/03/15/5c8bac8c90593.jpg alt=https://i.loli.net/2019/03/15/5c8bac8c90593.jpg title=5c8bac8c90593.jpg></p><p><strong>使用界面</strong></p><p><img loading=lazy decoding=async src=https://i.loli.net/2019/03/15/5c8bac8fbc0f4.jpg alt=https://i.loli.net/2019/03/15/5c8bac8fbc0f4.jpg title=5c8bac8fbc0f4.jpg></p><p>注意其中的<code>Include All option</code>，选中这个勾选框之后，下拉界面就能出现<code>All</code>这个选项，作用是查询语句将会使用(A|B|C)作为查询条件</p><p>在下拉选项少的情况下，这样用是一点问题也没有的，但是如果下拉选项很多的话，就会有问题，<code>Grafana</code>查询数据的时候是用<code>GET</code>方法查询的，即查询语句会出现在URL里，带来的一个问题是，如果走<code>nginx</code>的话，会被<code>nginx</code>拒绝掉，原因是nginx对URL的长度有限制。当然可以调整<code>nginx</code>配置来规避这个问题，还有一种办法是，通过自定义All的语义来更<strong>优雅</strong>的解决，如上所示，这边个性化了<code>Custom all value</code>为<code>.*</code>，熟悉正则的朋友肯定已经懂了，po个查询语句</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=k>sum</span><span class=p>(</span><span class=s2>&#34;value&#34;</span><span class=p>)</span> <span class=k>FROM</span> <span class=s2>&#34;table&#34;</span> <span class=k>WHERE</span> <span class=p>(</span><span class=s2>&#34;level&#34;</span> <span class=o>=~</span> <span class=o>/^</span><span class=err>$</span><span class=k>level</span><span class=err>$</span><span class=o>/</span> <span class=k>AND</span> <span class=err>$</span><span class=n>timeFilter</span> <span class=k>GROUP</span> <span class=k>BY</span> <span class=n>time</span><span class=p>(</span><span class=err>$</span><span class=n>__interval</span><span class=p>)</span> <span class=n>fill</span><span class=p>(</span><span class=k>null</span><span class=p>)</span>
</code></pre></div><blockquote><p>级连查询</p></blockquote><p><code>Grafana</code>支持你做级连查询，想一下省市级连就知道了</p><p>定义的方法如下</p><p>首先定义一个变量，命名为<code>level</code></p><pre><code>SHOW TAG VALUES FROM &quot;table&quot; WITH KEY = &quot;level&quot;
</code></pre><p>接着再定义一个变量，命名为<code>title</code></p><pre><code>SHOW TAG VALUES FROM &quot;table&quot; WITH KEY = &quot;level&quot; where &quot;level&quot; =~ /^level$/
</code></pre><blockquote><p>Legend Avg</p></blockquote><p>假如查询出来的series包含null值并且在Null value的配置里配置了<code>null as zero</code>的话，平均值计算出来的就会不对，它会将null值也累加到分母里，所以这里需要将Null value配置成<code>null</code>，来让前端忽略这个null值，参见<code>Ignore nulls unless 'null as zero' for series.stats.avg</code></p><blockquote><p>Group By Tags</p></blockquote><p>在列比较稀疏的情况下，比如，第一次写入的数据是A、B、C三列，第二次写入的数据是A、D、E三列，tag为X列，按照X列做group by，如果选择的字段是B列，则第一次数据的tag不会出现，只有选择两个公有的列，这里是A列，两次写入的数据的tag才会出现。</p><blockquote><p>如何隐藏Legend</p></blockquote><p>可以在Display里配置是否展示 Legend，具体配置见下图所示</p><p><img loading=lazy decoding=async src=https://i.loli.net/2019/05/30/5cef451c1f0e642733.jpg alt=https://i.loli.net/2019/05/30/5cef451c1f0e642733.jpg title=5cef451c1f0e642733.jpg></p><blockquote><p>环比、同比</p></blockquote><p>InfluxDB 提供了<code>derivative()</code>函数用来计算变化速率
e.x.</p><p><strong>raw_data</strong></p><pre><code>name: h2o_feet
time                   water_level
----                   -----------
2015-08-18T00:00:00Z   2.064
2015-08-18T00:06:00Z   2.116
2015-08-18T00:12:00Z   2.028
2015-08-18T00:18:00Z   2.126
2015-08-18T00:24:00Z   2.041
2015-08-18T00:30:00Z   2.051
</code></pre><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=n>DERIVATIVE</span><span class=p>(</span><span class=s2>&#34;water_level&#34;</span><span class=p>,</span><span class=mi>6</span><span class=n>m</span><span class=p>)</span> <span class=k>FROM</span> <span class=s2>&#34;h2o_feet&#34;</span> <span class=k>WHERE</span> <span class=s2>&#34;location&#34;</span> <span class=o>=</span> <span class=s1>&#39;santa_monica&#39;</span> <span class=k>AND</span> <span class=n>time</span> <span class=o>&gt;=</span> <span class=s1>&#39;2015-08-18T00:00:00Z&#39;</span> <span class=k>AND</span> <span class=n>time</span> <span class=o>&lt;=</span> <span class=s1>&#39;2015-08-18T00:30:00Z&#39;</span>
</code></pre></div><pre><code>name: h2o_feet
time			derivative
----			----------
2015-08-18T00:06:00Z	0.052000000000000046
2015-08-18T00:12:00Z	-0.08800000000000008
2015-08-18T00:18:00Z	0.09799999999999986
2015-08-18T00:24:00Z	-0.08499999999999996
2015-08-18T00:30:00Z	0.010000000000000231
</code></pre><p>计算6分钟的变化速率</p><pre><code>(2.116 - 2.064) / (6m / 6m)
--------------    ----------
       |              |
       |          the difference between the field values' timestamps / the specified unit
second field value - first field value
</code></pre><h2 id=参考资料>参考资料</h2><ul><li><a href=https://github.com/grafana/grafana/issues/8109 target=_blank rel="noopener noreffer">Request-URI Too Large</a></li><li><a href=https://github.com/grafana/grafana/issues/10322 target=_blank rel="noopener noreffer">Add support for InfluxDB <code>tz</code> clause</a></li><li><a href=https://docs.influxdata.com/influxdb/v1.4/query_language/data_exploration/#the-time-zone-clause target=_blank rel="noopener noreffer">The Time Zone Clause</a></li><li><a href=https://github.com/grafana/grafana/pull/3252 target=_blank rel="noopener noreffer">Ignore nulls unless &lsquo;null as zero&rsquo; for series.stats.avg</a></li></ul></div><div class=post style=padding-top:0><div class=post-share></div></div></div><div id=toc-final></div></article><div class="page single comments content-block-position"><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.82.0">Hugo</a> 强力驱动 | 主题 - <a href="https://ublogger.netlify.app/?utm_source=https://robbietree8.github.io/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2021</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="svg-icon icon-comments-fixed"></i></a></div><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"robbietree8/blog-comments"}}}</script><script src=/js/theme.min.js></script><script>(function(a,e,f,g,b,c,d){a[b]=a[b]||function(){(a[b].a=a[b].a||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym"),ym("75049342","init",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:null})</script><noscript><div><img src=https://mc.yandex.ru/watch/75049342 style=position:absolute;left:-9999px alt></div></noscript></body></html>